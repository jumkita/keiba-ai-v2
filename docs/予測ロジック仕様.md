# 予測ロジック仕様書

## 1. 算出ロジックの全体フロー

```
Snap.mdb 抽出 → 未来レース絞り込み → 血統スコア算出 → Logic Score → AI予測 → Final Score → 印付与
```

---

## 2. 各ステップの詳細

### 2.1 データ抽出

- **入力**: Snap.mdb（出走表馬群）、Race.mdb、Master.mdb
- **抽出**: RaceID + UmaCode を持つテーブルから、Race/Master を結合して取得
- **対象**: `race_key` の日付部分（YYYYMMDD）が **更新実行日以上のレース** のみ

### 2.2 距離・コース区分

| 区分 | 条件 |
|------|------|
| short | 距離 < 1400m |
| mile | 1400m ≤ 距離 ≤ 1800m |
| mid | 1800m < 距離 ≤ 2400m |
| long | 距離 > 2400m |

- **コース**: TrackCD 10〜22 → 芝(1)、それ以外 → ダート(2)

### 2.3 血統スコア（pedigree_score）

**父スコア (sire_score)**
1. `sire_name` が sire_features_master にあればその `{course}_{dist}_place` を使用
2. なければ sire_gf_map で祖父IDを取得 → sire_id_map で祖父名に変換 → 祖父のスコアを使用（Fallback）
3. どちらもなければ global_stats の `place_rate`（デフォルト 0.25）

**母父スコア (bms_score)**
1. `bms_name` が bms_features_master にあればそのスコアを使用
2. なければ bms_father_map で母父の父IDを取得 → bms_id_map で名前変換 → 母父の父のスコアを使用（Fallback）
3. どちらもなければ global_stats の `place_rate`

**pedigree_score**
```
pedigree_score = 0.7 × sire_score + 0.3 × bms_score
```

### 2.4 Logic Score

- 同じレース内の `pedigree_score` を Min-Max 正規化（0〜1）
- 同点時は logic_score でランク付けして順位ベースで正規化

### 2.5 AI 予測（LightGBM）

**特徴量**（13次元）:
- sire_id_int, bms_id_int: 父・母父の整数ID（学習時に付与）
- distance: 距離(m)
- course_type: 1=芝, 2=ダート
- odds_tansho: 単勝オッズ（欠損時 10.0）
- turf_short_place, turf_mile_place, turf_mid_place, turf_long_place
- dirt_short_place, dirt_mile_place, dirt_mid_place, dirt_long_place  
  （該当する course×dist は血統スコア、それ以外は global_stats.place_rate）

**モデル**: 二値分類（複勝＝1〜3着なら1、それ以外0）、binary logloss

### 2.6 最終スコアと印

- **raw_pred**: LightGBM の生の予測値
- **ai_score**: レース内で raw_pred を Min-Max 正規化（fallback_rank は logic_score の降順）
- **final_score**: `0.7 × ai_score + 0.3 × logic_score`
- **印**: final_score 降順で ◎○▲△⭐ を付与

---

## 3. 前処理・マスタの算出（preprocess_master.py）

- **global_stats**: 芝/ダート × short/mile/mid/long ごとの win_rate, place_rate
- **sire_features_master / bms_features_master**: 父名/母父名 × 芝/ダ × 距離 ごとの win_rate, place_rate  
  - 出走 10 回未満は global_stats で補完
- **sire_name_to_int / bms_name_to_int**: 学習データに登場した名前一覧の整数マッピング

---

## 4. モデル学習（train_model.py）

- **目的変数**: rank 1〜3 → 1、それ以外 → 0
- **特徴量**: predict 時と同じ 13 次元
- **odds_tansho**: 学習データにないため 10.0 で固定
- **ハイパラ**: num_leaves=31, learning_rate=0.05, num_boost_round=200

---

## 5. 改善すべきポイント

### 5.1 特徴量・モデル

| 項目 | 現状 | 改善案 |
|------|------|--------|
| オッズ | 学習時 10.0 固定、予測時は実オッズ | オッズが未確定の出走表でも、過去の類似馬の平均オッズや人気予測を特徴量に追加 |
| 騎手・調教師 | 未使用 | 騎手・調教師の成績を特徴量に追加 |
| 馬体重・増減 | 未使用 | 馬体重・前走比の増減を特徴量に追加 |
| 枠番 | 未使用 | 枠番や馬番を特徴量に追加 |
| モデル検証 | なし | 時系列で Train/Valid を分割し、将来データでの性能を検証 |
| ハイパラ | 固定 | Optuna 等でチューニング |

### 5.2 血統ロジック

| 項目 | 現状 | 改善案 |
|------|------|--------|
| 重み | 父 70% / 母父 30% 固定 | 距離・コース別に最適重みを学習 or グリッドサーチ |
| 距離区分 | 4区分（short/mile/mid/long） | もっと細かい区分（例: 1000/1200/1400/...）や連続値化 |
| Fallback | 祖父/母父の父のみ | さらに上世代への遡及、または複数候補の加重平均 |

### 5.3 スコア合成

| 項目 | 現状 | 改善案 |
|------|------|--------|
| Final | 0.7×AI + 0.3×Logic 固定 | 重みを学習 or スタッキングで meta-model に任せる |
| 同点処理 | logic_score のランクで正規化 | より明確な tie-break ルールの定義 |

### 5.4 データ・前処理

| 項目 | 現状 | 改善案 |
|------|------|--------|
| global_stats | turf の count が 0 の可能性 | turf データの有無を確認し、不足時は補完ロジックを追加 |
| 馬名・血統 | 未出走馬は Unknown になりやすい | 出走前でも血統IDから sire/bms マスタを引けるよう補強 |
| build_grandfather_map | sire_to_grandfather, bms_to_father の導出が horse→sire のペアのみ | 正しい sire→祖父、bms→父 のマッピングに修正 |

### 5.5 運用・品質

| 項目 | 現状 | 改善案 |
|------|------|--------|
| 評価指標 | なし | 予測精度（複勝率、回収率）のバックテストを実施 |
| ログ | 一部 print | 構造化ログ（JSON）で実行結果を記録 |
| 再現性 | 乱数固定なし | 学習時は seed 固定 |
